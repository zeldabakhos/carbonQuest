name: Scheduled Health Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: API Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Check Production API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.carbonquest.com || echo "000")
          if [ "$response" != "200" ]; then
            echo "âŒ Production API is down! Status: $response"
            exit 1
          fi
          echo "âœ… Production API is healthy"
        continue-on-error: true

      - name: ğŸ” Check Staging API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://staging.carbonquest.com || echo "000")
          if [ "$response" != "200" ]; then
            echo "âŒ Staging API is down! Status: $response"
            exit 1
          fi
          echo "âœ… Staging API is healthy"
        continue-on-error: true

      - name: ğŸ“§ Send notification on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸš¨ CarbonQuest API Health Check Failed'
          to: ${{ secrets.ALERT_EMAIL }}
          from: GitHub Actions
          body: 'API health check failed. Please investigate immediately.'
        continue-on-error: true

  database-backup:
    name: Database Backup
    runs-on: ubuntu-latest
    if: github.event.schedule != ''
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’¾ Backup MongoDB
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # Create backup directory
            mkdir -p /var/backups/mongodb
            
            # Backup database
            mongodump --db carbonquest --out /var/backups/mongodb/$(date +%Y%m%d_%H%M%S)
            
            # Keep only last 7 days of backups
            find /var/backups/mongodb -type d -mtime +7 -exec rm -rf {} +
            
            echo "âœ… Database backup completed"
        continue-on-error: true